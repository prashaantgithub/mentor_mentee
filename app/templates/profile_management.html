{% extends "base.html" %}
{% block title %}Profile Management{% endblock %}
{% block content %}
<div class="page-header"><h1>Profile Management</h1></div>
<div class="card">
    <form id="profile-form">
        <div class="form-group"><label>Name</label><input type="text" id="name" value="{{ current_user.name }}" readonly></div>
        <div class="form-group"><label>Email</label><input type="email" id="email" value="{{ current_user.email }}" readonly></div>
        <div id="extra-fields"></div>
    </form>
</div>
<div class="card">
    <h2>Change Password</h2>
    <form id="password-form">
        <div class="form-group"><label>Current Password</label><input type="password" id="current_password" required></div>
        <div class="form-group"><label>New Password</label><input type="password" id="new_password" required></div>
        <button type="submit" class="btn btn-secondary">Change Password</button>
    </form>
</div>
{% endblock %}
{% block body_extra %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const extraFields = document.getElementById('extra-fields');
    const passwordForm = document.getElementById('password-form');
    const userId = document.body.dataset.userId;

    const res = await fetch(`/api/user/${userId}`);
    const data = await res.json();
    if(data.success) {
        const user = data.user;
        let fieldsHtml = `<div class="form-group"><label>Department</label><input type="text" value="${user.department || ''}" readonly></div>`;
        if(user.role === 'mentor') {
            fieldsHtml += `<div class="form-group"><label>Expertise</label><input type="text" value="${user.expertise || ''}" readonly></div>`;
        } else if (user.role === 'mentee') {
            fieldsHtml += `<div class="form-group"><label>Semester</label><input type="number" value="${user.semester || ''}" readonly></div>`;
            fieldsHtml += `<div class="form-group"><label>GPA</label><input type="number" step="0.01" value="${user.gpa || ''}" readonly></div>`;
        }
        extraFields.innerHTML = fieldsHtml;
    }

    passwordForm.addEventListener('submit', async e => {
        e.preventDefault();
        const payload = {
            current_password: document.getElementById('current_password').value,
            new_password: document.getElementById('new_password').value
        };
        const response = await fetch('/api/profile/change_password', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
        });
        const result = await response.json();
        if(response.ok) passwordForm.reset();
        alert(result.message);
    });
});
</script>
{% endblock %}