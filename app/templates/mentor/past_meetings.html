{% extends "base.html" %}
{% block title %}Mark Past Meetings{% endblock %}
{% block content %}
<div class="page-header"><h1>Mark Past Meetings</h1><p>Update the status of meetings that have already passed.</p></div>
<div class="card"><div id="past-meetings-list"></div></div>
<div id="missed-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content"><span class="close-button">Ã—</span><h2>Mark Meeting as Missed</h2>
        <form id="missed-form"><input type="hidden" id="missed-meeting-id">
            <div class="form-group"><label>Who missed the meeting?</label>
                <select id="missed-by" class="form-control"><option value="mentee">Mentee</option><option value="mentor">Mentor</option></select>
            </div>
            <div class="form-group"><label>Reason</label><textarea id="missed-reason" rows="3" required></textarea></div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>
</div>
{% endblock %}
{% block body_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const list = document.getElementById('past-meetings-list');
    const modal = document.getElementById('missed-modal');

    async function loadPastMeetings() {
        const response = await fetch('/api/past_meetings');
        const data = await response.json();
        list.innerHTML = '';
        if (data.success && data.meetings.length > 0) {
            data.meetings.forEach(m => {
                list.innerHTML += `<div class="action-item card"><h4>${m.title}</h4><p>Date: ${m.date}</p><div class="action-buttons"><button class="btn btn-primary btn-sm completed-btn" data-id="${m.id}">Mark Completed</button><button class="btn btn-secondary btn-sm missed-btn" data-id="${m.id}">Mark Missed</button></div></div>`;
            });
        } else {
            list.innerHTML = '<p>No past meetings require action.</p>';
        }
    }
    
    list.addEventListener('click', e => {
        const meetingId = e.target.dataset.id;
        if (e.target.classList.contains('completed-btn')) {
            fetch(`/api/meeting/${meetingId}/mark_completed`, {method: 'POST'}).then(loadPastMeetings);
        } else if (e.target.classList.contains('missed-btn')) {
            document.getElementById('missed-meeting-id').value = meetingId;
            modal.style.display = 'flex';
        }
    });

    document.getElementById('missed-form').addEventListener('submit', async e => {
        e.preventDefault();
        const payload = { missed_by: document.getElementById('missed-by').value, reason: document.getElementById('missed-reason').value };
        await fetch(`/api/meeting/${document.getElementById('missed-meeting-id').value}/mark_missed`, {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
        });
        modal.style.display = 'none';
        loadPastMeetings();
    });
    
    modal.querySelector('.close-button').addEventListener('click', () => modal.style.display = 'none');
    loadPastMeetings();
});
</script>
{% endblock %}